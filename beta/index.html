<!DOCTYPE html>
<html>
    <head>
        <title>minecraft web edition 0.0.1-B</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link href="style/main.css" rel="stylesheet" type="text/css">
        <link href="media/favicon.png" rel="icon" type="image/png" sizes="64x64">
    </head>
    <body>
        <audio id="clickSound" src="sounds/gui/Click_stereo.ogg.mp3" preload="auto"></audio>

        <div class="gui" id="mainMenu">
            <div class="mainmenu">
                <button id="playButton" class="button">Singleplayer</button>
                <form method="post" action="multiplayer.html">
                    <button type="submit" class="button" disabled>Multiplayer</button>
                </form>
                <button id="settingsButton" class="button">Settings</button>
            </div>
        </div>

        <div class="separar"></div>
        <div class="logo"></div>

        <div id="settingsMenu" class="gui" style="display: none;">
			<div class="mainmenu">
				<button class="button" id="backButton">Volver</button>
				<div style="margin: 20px 0;">
					<label for="renderDistanceSlider" style="color: white; font-family: Minecraftia;">Render Distance: <span id="renderDistanceValue">8</span> chunks</label><br>
					<input type="range" id="renderDistanceSlider" min="5" max="16" value="8" step="1" style="width: 200px; margin-top: 10px;">
				</div>
				<div style="margin: 20px 0;">
					<label style="color: white; font-family: Minecraftia;">
						<input type="checkbox" id="fpsToggle" style="margin-right: 10px;">Mostrar FPS
					</label>
				</div>
			</div>
		</div>

        <!-- World manager submenu -->
        <div id="worldsMenu" class="gui worlds-menu" style="display: none;">
            <div class="mainmenu">
                <button class="button" id="worldsBackButton">Volver</button>
                <div id="worldListContainer"></div>
                <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px; align-items: center;">
                    <button class="button" id="createWorldButton">Crear nuevo mundo</button>
                    <button class="button" id="importWorldButton">Importar mundo</button>
                </div>
                <input type="file" id="importWorldInput" accept=".json,application/json" style="display: none;" />
            </div>
        </div>

        <div class="separar1"></div>
        <a class="version">minecraft web edition 0.0.1-B</a>

        <!-- Modules for world management -->
        <script src="js/glMatrix-1.2.min.js" type="text/javascript"></script>
        <script src="js/helpers.js" type="text/javascript"></script>
        <script src="js/blocks.js" type="text/javascript"></script>
        <script src="js/world.js" type="text/javascript"></script>

        <script>
            // Play click sound function
            function playClickSound() {
                clickSound.currentTime = 0;
                clickSound.play().catch(function(e) { console.log('Audio play failed:', e); });
            }

            // World manager submenu elements
            var mainMenu = document.getElementById('mainMenu');
            var worldsMenu = document.getElementById('worldsMenu');
            var worldListContainer = document.getElementById('worldListContainer');
            var createWorldButton = document.getElementById('createWorldButton');
            var importWorldButton = document.getElementById('importWorldButton');
            var importWorldInput = document.getElementById('importWorldInput');
            var worldsBackButton = document.getElementById('worldsBackButton');

            // Helper to refresh world list from localStorage
            function refreshWorldList() {
                worldListContainer.innerHTML = '';

                var worlds = World.getSavedWorlds();
                if (!worlds || worlds.length === 0) {
                    var emptyMsg = document.createElement('div');
                    emptyMsg.className = 'world-empty';
                    emptyMsg.textContent = 'No hay mundos guardados';
                    worldListContainer.appendChild(emptyMsg);
                    return;
                }

                worlds.forEach(function(w) {
                    var row = document.createElement('div');
                    row.className = 'world-row';

                    var info = document.createElement('div');
                    info.className = 'world-info';

                    var nameSpan = document.createElement('div');
                    nameSpan.className = 'world-info-name';
                    nameSpan.textContent = w.name;
                    info.appendChild(nameSpan);

                    if (w.metadata && w.metadata.lastPlayed) {
                        var dateSpan = document.createElement('div');
                        dateSpan.className = 'world-info-meta';
                        dateSpan.textContent = 'Última vez jugado: ' + new Date(w.metadata.lastPlayed).toLocaleString();
                        info.appendChild(dateSpan);
                    }

                    row.appendChild(info);

                    var actions = document.createElement('div');
                    actions.className = 'world-actions';

                    var playBtn = document.createElement('button');
                    playBtn.className = 'button-small';
                    playBtn.textContent = 'Jugar';
                    playBtn.onclick = function() {
                        playClickSound();
                        sessionStorage.setItem('selectedWorld', w.name);
                        window.location.href = 'singleplayer.html';
                    };
                    actions.appendChild(playBtn);

                    var exportBtn = document.createElement('button');
                    exportBtn.className = 'button-small';
                    exportBtn.textContent = 'Exportar';
                    exportBtn.onclick = function() {
                        playClickSound();
                        try {
                            var tmpWorld = new World(1, 1, 1, 16);
                            if (!tmpWorld.exportWorld(w.name)) {
                                alert('No se pudo exportar el mundo.');
                            }
                        } catch (e) {
                            console.error('Error al exportar mundo:', e);
                            alert('Error al exportar el mundo. Revisa la consola.');
                        }
                    };
                    actions.appendChild(exportBtn);

                    var renameBtn = document.createElement('button');
                    renameBtn.className = 'button-small';
                    renameBtn.textContent = 'Renombrar';
                    renameBtn.onclick = function() {
                        playClickSound();
                        var newName = prompt('Nuevo nombre del mundo:', w.name);
                        if (!newName || newName === w.name) return;

                        var existing = World.getSavedWorlds().some(function(other) { return other.name === newName; });
                        if (existing) {
                            alert('Ya existe un mundo con ese nombre');
                            return;
                        }

                        var oldKey = 'minecraft_world_' + w.name;
                        var compressedData = localStorage.getItem(oldKey);
                        if (!compressedData) {
                            alert('No se pudo renombrar el mundo (datos no encontrados).');
                            return;
                        }

                        try {
                            var worldData = JSON.parse(atob(compressedData));
                            worldData.metadata = worldData.metadata || {};
                            worldData.metadata.name = newName;
                            var newCompressed = btoa(JSON.stringify(worldData));

                            // Save under new name and remove old
                            localStorage.setItem('minecraft_world_' + newName, newCompressed);
                            localStorage.removeItem(oldKey);

                            // Update world list metadata
                            var tmpWorld = new World(1, 1, 1, 16);
                            tmpWorld.updateWorldList(w.name, true);
                            tmpWorld.updateWorldList(newName, false);

                            refreshWorldList();
                        } catch (e) {
                            console.error('Error al renombrar mundo:', e);
                            alert('Error al renombrar el mundo. Revisa la consola.');
                        }
                    };
                    actions.appendChild(renameBtn);

                    var deleteBtn = document.createElement('button');
                    deleteBtn.className = 'button-small';
                    deleteBtn.textContent = 'Borrar';
                    deleteBtn.onclick = function() {
                        playClickSound();
                        if (confirm('¿Eliminar el mundo "' + w.name + '"?')) {
                            try {
                                localStorage.removeItem('minecraft_world_' + w.name);
                                var tmpWorld = new World(1, 1, 1, 16);
                                tmpWorld.updateWorldList(w.name, true);
                            } catch (e) {
                                console.error('Error al eliminar mundo:', e);
                            }
                            refreshWorldList();
                        }
                    };
                    actions.appendChild(deleteBtn);

                    row.appendChild(actions);
                    worldListContainer.appendChild(row);
                });
            }

            // Singleplayer button handler - open world manager submenu
            document.getElementById('playButton').onclick = function() {
                playClickSound();
                mainMenu.style.display = 'none';
                worldsMenu.style.display = 'flex';
                refreshWorldList();
            };

            // Create new world from main menu
            createWorldButton.onclick = function() {
                playClickSound();
                var name = prompt('Nombre del nuevo mundo:', 'Nuevo Mundo');
                if (!name) return;

                // Avoid overwriting existing worlds
                var existing = World.getSavedWorlds().some(function(w) { return w.name === name; });
                if (existing) {
                    alert('Ya existe un mundo con ese nombre');
                    return;
                }

                // Create basic flat world and save metadata
                var wSize = 256;
                var world = new World(wSize, wSize, 128, 16);
                world.metadata.name = name;
                world.createFlatWorld(64);
                world.saveToLocalStorage(name);

                // Start playing in the new world
                sessionStorage.setItem('selectedWorld', name);
                window.location.href = 'singleplayer.html';
            };

            // Import world from JSON file
            importWorldButton.onclick = function() {
                playClickSound();
                if (importWorldInput) {
                    importWorldInput.click();
                }
            };

            importWorldInput.onchange = function(event) {
                var file = event.target.files && event.target.files[0];
                if (!file) return;

                World.importWorld(file, function(success, result) {
                    if (success) {
                        try {
                            var tmpWorld = new World(1, 1, 1, 16);
                            tmpWorld.updateWorldList(result, false);
                        } catch (e) {
                            console.error('Error al actualizar lista de mundos tras importar:', e);
                        }
                        alert('Mundo importado correctamente: ' + result);
                        refreshWorldList();
                    } else {
                        alert('Error al importar el mundo: ' + result);
                    }
                    // Reset input so the same file can be selected again later
                    importWorldInput.value = '';
                });
            };

            // World manager back button
            worldsBackButton.onclick = function() {
                playClickSound();
                worldsMenu.style.display = 'none';
                mainMenu.style.display = 'flex';
            };

            // Settings menu handlers
            var settingsMenu = document.getElementById('settingsMenu');
            var backButton = document.getElementById('backButton');
            document.getElementById('settingsButton').onclick = function() {
                playClickSound();
                mainMenu.style.display = 'none';
                settingsMenu.style.display = 'flex';
            };
            document.getElementById('backButton').onclick = function() {
                playClickSound();
                settingsMenu.style.display = 'none';
                mainMenu.style.display = 'flex';
            };

			// Render distance slider setup
			var renderDistanceSlider = document.getElementById('renderDistanceSlider');
			var renderDistanceValue = document.getElementById('renderDistanceValue');

			// Load saved render distance or use default
			var savedRenderDistance = localStorage.getItem('renderDistance') || '8';
			renderDistanceSlider.value = savedRenderDistance;
			renderDistanceValue.textContent = savedRenderDistance;

			// Set slider range (4-16 for title screen, will be adjusted in-game based on device)
			renderDistanceSlider.min = 4;
			renderDistanceSlider.max = 16;

			// Update display and save to localStorage when slider changes
			renderDistanceSlider.oninput = function() {
				var value = parseInt(this.value);
				renderDistanceValue.textContent = value;
				localStorage.setItem('renderDistance', value);
			};

			// FPS toggle setup
			var fpsToggle = document.getElementById('fpsToggle');

			// Load FPS setting from localStorage
			var savedShowFPS = localStorage.getItem('showFPS') || 'false';
			fpsToggle.checked = savedShowFPS === 'true';

			// Handle FPS toggle changes
			fpsToggle.onchange = function() {
				localStorage.setItem('showFPS', fpsToggle.checked);
			};
        </script>
    </body>
</html>
