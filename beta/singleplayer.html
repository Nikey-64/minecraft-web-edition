<!DOCTYPE HTML>
<html>
	<head>
		<title>Minecraft Web Edition 0.0.1-B</title>
		<link href="media/favicon.png" rel="icon" type="image/png" sizes="64x64">
		
		<!-- Character encoding -->
		<meta http-equiv="content-type" content="text/html;" charset="UTF-8" >
		
		<!-- Stylesheet -->
		<link href="style/main.css" rel="stylesheet" type="text/css">
		
		<!-- Modules -->
		<script src="js/glMatrix-1.2.min.js" type="text/javascript"></script>
		<script src="js/blocks.js" type="text/javascript"></script>
		<script src="js/helpers.js" type="text/javascript"></script>
		<script src="js/world.js" type="text/javascript"></script>
		<script src="js/render.js" type="text/javascript"></script>
		<script src="js/physics.js" type="text/javascript"></script>
		<script src="js/player.js" type="text/javascript"></script>
	</head>
	
	<body oncontextmenu="return false">
		<!-- Render surface -->
		<canvas id="renderSurface"></canvas>

		<!-- Cursor icon -->
		<img id="cursorIcon" src="media/cursor.png" alt="Cursor">

		<!-- Pause menu -->
		 <audio id="clickSound" src="sounds/gui/Click_stereo.ogg.mp3" preload="auto"></audio>
        <div class="separar">
		<div id="pauseMenu" class="gui gui-overlay" style="display: none;">
			<div class="mainmenu">
				<button class="button" id="resumeButton">Volver al juego</button>
				<button class="button" id="settingsButton">Ajustes</button>
				<button class="button" id="exitButton">Salir</button>

			</div>
			</div>
		</div>

		<!-- Settings menu -->
		<div id="settingsMenu" class="gui gui-overlay" style="display: none;">
			<div class="mainmenu">
				<button class="button" id="backButton">Volver</button>
				<div style="margin: 20px 0;">
					<label for="renderDistanceSlider" style="color: white; font-family: Minecraftia;">Render Distance: <span id="renderDistanceValue">8</span> chunks</label><br>
					<input type="range" id="renderDistanceSlider" min="5" max="16" value="8" step="1" style="width: 200px; margin-top: 10px;">
				</div>
				<div style="margin: 20px 0;">
					<label style="color: white; font-family: Minecraftia;">
						<input type="checkbox" id="fpsToggle" style="margin-right: 10px;">Mostrar FPS
					</label>
				</div>
			</div>
		</div>

		<!-- Material selection -->
		<table id="materialSelector">
			<tr></tr>
		</table>
		
		<!-- Client detection display (temporary debug info) -->
		<div id="clientInfo" style="position: fixed; bottom: 10px; left: 10px; color: white; font-family: Minecraftia; font-size: 12px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 3px; z-index: 1000;"></div>

		<!-- Initialisation code -->
		<script type="text/javascript">
			// Create or load world with chunk-based system
			// If the player selected a world in the main menu, load it from localStorage.
			// Otherwise, create a new flat world as a fallback.
			var selectedWorldName = sessionStorage.getItem('selectedWorld');
			var initialSize = clientInfo && clientInfo.isLowEnd ? 128 : 256;
			var world = new World( initialSize, initialSize, 128, 16 ); // temporary dimensions; real ones come from load
			
			if ( selectedWorldName && world.loadFromLocalStorage( selectedWorldName ) ) {
				console.log('Loaded world from storage:', selectedWorldName);
			} else {
				// Fallback: create a new flat world
				var worldSize = clientInfo && clientInfo.isLowEnd ? 128 : 256;
				world = new World( worldSize, worldSize, 128, 16 );
				world.metadata.name = selectedWorldName || "Nuevo Mundo";
				world.createFlatWorld( 64 );
				world.saveToLocalStorage( world.metadata.name );
			}
			
			// Ensure spawn point exists (for old worlds that may not have one)
			if ( !world.spawnPoint ) {
				world.spawnPoint = new Vector( world.sx / 2 + 0.5, world.sy / 2 + 0.5, 64 );
			}
			
			// Set up renderer
			var render = new Renderer( "renderSurface" );
			render.setWorld( world, 4 );
			render.setPerspective( 60, 0.01, 200 );
			
			// Create physics simulator
			var physics = new Physics();
			physics.setWorld( world );
			
			// Create new local player
			var player = new Player();
			player.setWorld( world );
			player.setInputCanvas( "renderSurface" );
			player.setMaterialSelector( "materialSelector" );
			
			// Autosave configuration
			var AUTO_SAVE_INTERVAL_MS = 5 * 60 * 1000; // 5 minutes
			var lastAutoSaveTime = Date.now();
			var AUTO_SAVE_DISTANCE_SQUARED = 64 * 64; // save when 64+ blocks away from last change
			
			function saveWorld(reason) {
				if (!world || typeof world.saveToLocalStorage !== 'function') return;
				var nameToSave = world.metadata && world.metadata.name ? world.metadata.name : ( selectedWorldName || 'Nuevo Mundo' );
				var ok = world.saveToLocalStorage( nameToSave );
				if ( ok ) {
					world.hasUnsavedChanges = false;
					lastAutoSaveTime = Date.now();
				}
			}

			// Autosave on interval
			setInterval(function() {
				if ( Date.now() - lastAutoSaveTime >= AUTO_SAVE_INTERVAL_MS ) {
					saveWorld('interval');
				}
			}, 10000); // check every 10s

			// Save world when leaving page
			window.addEventListener('beforeunload', function() {
				saveWorld('beforeunload');
			});

					// Load render distance from localStorage
					var savedRenderDistance = localStorage.getItem('renderDistance');
			if (savedRenderDistance) {
				if ( render.setRenderDistance ) {
					render.setRenderDistance( parseInt(savedRenderDistance) );
				} else {
					render.renderDistance = parseInt(savedRenderDistance);
					if ( render.updateRenderDistanceSquared ) {
						render.updateRenderDistanceSquared();
					}
				}
			} else {
				// Default to 8 chunks if not saved
				if ( render.setRenderDistance ) {
					render.setRenderDistance( 8 );
				} else {
					render.renderDistance = 8;
					if ( render.updateRenderDistanceSquared ) {
						render.updateRenderDistanceSquared();
					}
				}
			}

			// Menu variables
			var isPaused = false;
			var pauseMenu = document.getElementById('pauseMenu');
			var settingsMenu = document.getElementById('settingsMenu');
			var cursorIcon = document.getElementById('cursorIcon');
			var materialSelector = document.getElementById('materialSelector');

			// Get the click sound element
			var clickSound = document.getElementById('clickSound');

			// Function to show pause menu
			function showPauseMenu() {
				isPaused = true;
				pauseMenu.style.display = 'flex';
				cursorIcon.style.display = 'none';
				materialSelector.style.display = 'none';
				document.exitPointerLock();
			}

			// Function to hide pause menu
			function hidePauseMenu() {
				isPaused = false;
				pauseMenu.style.display = 'none';
				settingsMenu.style.display = 'none';
				cursorIcon.style.display = 'block';
				materialSelector.style.display = 'table';
				document.getElementById('renderSurface').requestPointerLock();
			}

			// Event listeners for buttons with sound
			document.getElementById('resumeButton').onclick = function() {
				clickSound.play();
				hidePauseMenu();
			};
			document.getElementById('settingsButton').onclick = function() {
				clickSound.play();
				pauseMenu.style.display = 'none';
				settingsMenu.style.display = 'flex';
			};
			document.getElementById('backButton').onclick = function() {
				clickSound.play();
				settingsMenu.style.display = 'none';
				pauseMenu.style.display = 'flex';
			};
			document.getElementById('exitButton').onclick = function() {
				clickSound.play();
				// Save current world before exiting
				if ( world && typeof world.saveToLocalStorage === 'function' ) {
					var nameToSave = world.metadata && world.metadata.name ? world.metadata.name : ( selectedWorldName || 'Nuevo Mundo' );
					world.saveToLocalStorage( nameToSave );
				}
				// Clear selected world and return to main menu
				sessionStorage.removeItem('selectedWorld');
				window.location.href = 'index.html';
			};

			// Render distance slider setup
			var renderDistanceSlider = document.getElementById('renderDistanceSlider');
			var renderDistanceValue = document.getElementById('renderDistanceValue');

			// Set initial slider value from renderer (client-optimized default)
			renderDistanceSlider.value = render.renderDistance;
			renderDistanceValue.textContent = render.renderDistance;

			// Adjust slider range based on client capabilities
			if (clientInfo.isLowEnd) {
				renderDistanceSlider.min = 4;
				renderDistanceSlider.max = 8;
			} else if (clientInfo.isMobile) {
				renderDistanceSlider.min = 4;
				renderDistanceSlider.max = 12;
			} else {
				renderDistanceSlider.min = 4;
				renderDistanceSlider.max = 16;
			}

			// Update display and renderer when slider changes
			renderDistanceSlider.oninput = function() {
				var value = parseInt(this.value);
				renderDistanceValue.textContent = value;
				if ( render.setRenderDistance ) {
					render.setRenderDistance( value );
				} else {
					render.renderDistance = value;
					if ( render.updateRenderDistanceSquared ) {
						render.updateRenderDistanceSquared();
					}
				}
				localStorage.setItem('renderDistance', value);
				
				// Force update of active chunks when render distance changes
				if ( render.camPos ) {
					render.updateActiveChunks();
				} else if ( world && world.spawnPoint ) {
					render.activateChunksAroundPosition( world.spawnPoint );
				}
			};

			// FPS toggle setup
			var fpsToggle = document.getElementById('fpsToggle');

			// Load FPS setting from localStorage
			var savedShowFPS = localStorage.getItem('showFPS');
			if (savedShowFPS === 'true') {
				fpsToggle.checked = true;
				if (render && typeof render.toggleFPS === 'function') {
					render.toggleFPS();
				}
			}

			// Handle FPS toggle changes
			fpsToggle.onchange = function() {
				if (render && typeof render.toggleFPS === 'function') {
					render.toggleFPS();
					localStorage.setItem('showFPS', fpsToggle.checked);
				}
			};

			// Display client info for debugging
			var clientInfoDiv = document.getElementById('clientInfo');
			clientInfoDiv.innerHTML = 'Client: ' + (clientInfo.isLowEnd ? 'Low-End' : (clientInfo.isMobile ? 'Mobile' : 'Desktop')) +
			                          '<br>Render Distance: ' + render.renderDistance;

			// Listen for pointer lock change
			document.addEventListener('pointerlockchange', function() {
				try {
					if (!document.pointerLockElement) {
						showPauseMenu();
					}
				} catch (e) {
					console.warn('Pointer lock error:', e);
				}
			});

			// Listen for Escape key to pause
			document.addEventListener('keydown', function(e) {
				if (e.key === 'Escape') {
					if (isPaused) {
						hidePauseMenu();
					} else {
						showPauseMenu();
					}
				}
			});

			// Render loop
			setInterval( function()
			{
				if (!isPaused) {
					var time = new Date().getTime() / 1000.0;
					

					// Simulate physics
					physics.simulate();

					// Update local player
					player.update();

					// Distance-based autosave after block changes
					if ( world && world.hasUnsavedChanges && world.lastModifiedPos ) {
						var dx = player.pos.x - world.lastModifiedPos.x;
						var dy = player.pos.y - world.lastModifiedPos.y;
						var dz = player.pos.z - world.lastModifiedPos.z;
						var distSq = dx*dx + dy*dy + dz*dz;
						if ( distSq >= AUTO_SAVE_DISTANCE_SQUARED ) {
							saveWorld('distance');
						}
					}

					// Build chunks
					render.buildChunks( 64 );

					// Draw world
					render.setCamera( player.getEyePos().toArray(), player.angles );
					render.draw();

					while ( new Date().getTime() / 1000 - time < 0.016 );
						

			
				}}, 1);
		</script>
	</body>
</html>